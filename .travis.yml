language: node_js
# When changing node version also update it on lines 34, 36 and 46.
node_js:
  - "6"
  - "4"

sudo: false

cache:
  directories:
    - node_modules

addons:
  apt:
    sources:
      - sourceline: 'deb https://dl.yarnpkg.com/debian/ stable main'
        key_url: 'https://dl.yarnpkg.com/debian/pubkey.gpg'
    packages:
      - yarn

env:
  global:
    - GITHUB_OAUTH_KEY=003a44d58f12089d0c0261338298af3813330949
  matrix:
    - DB=sqlite3 NODE_ENV=testing
    - DB=mysql NODE_ENV=testing-mysql

matrix:
  include:
    - node_js: "6"
      env: TEST_SUITE=lint
    - node_js: "6"
      env: TEST_SUITE=coverage DB=sqlite3 NODE_ENV=testing
  
branches:
  except:
    - /^greenkeeper-.+$/

before_install:
  - if [ $DB == "mysql" ]; then mysql -e 'create database ghost_testing'; fi
  - mkdir -p $HOME/bin
  - curl -fsSL https://testspace-client.s3.amazonaws.com/testspace-linux.tgz | tar -zxvf- -C $HOME/bin
  - testspace config url open.testspace.com

install:
  - yarn
  - if [ "$DB" == "sqlite3" ]; then yarn add --force sqlite3; fi # fix sqlite caching issues

after_script:
  - |
    if [ "${TEST_SUITE}" = "lint" ]; then
       testspace *checkstyle-result.xml
    elif [ "${TEST_SUITE}" = "coverage" ]; then
       testspace [${TEST_SUITE}]xunit.xml{core} [${TEST_SUITE}]core/test/coverage/unit/cobertura-coverage.xml
    else 
       testspace [Node-$TRAVIS_NODE_VERSION-$DB/]*-xunit.xml{core}
    fi 